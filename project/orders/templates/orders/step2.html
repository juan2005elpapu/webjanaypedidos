{% extends "orders/base_step.html" %}
{% load humanize %}

{% block step_content %}
<form method="post" id="step-form" class="p-4 md:p-6">
    {% csrf_token %}
    
    <div class="step2-grid">
        <!-- Secci√≥n principal vac√≠a con bot√≥n -->
        <div class="step2-products-section">
            <div class="empty-products-container">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center w-20 h-20 md:w-24 md:h-24 bg-orange-100 rounded-full mb-4 md:mb-6">
                        <span class="material-icons text-orange-600 text-3xl md:text-4xl">restaurant_menu</span>
                    </div>
                    <h3 class="text-base md:text-lg font-medium text-gray-900 mb-2">Selecciona tus productos</h3>
                    <p class="text-sm md:text-base text-gray-500 mb-4 md:mb-6">Haz clic en el bot√≥n para explorar nuestro men√∫</p>
                    
                    <button type="button" 
                            id="add-products-btn" 
                            class="btn-add-products">
                        <span class="material-icons mr-2">add_shopping_cart</span>
                        A√±adir Productos
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Resumen del pedido -->
        <div class="step2-summary-section">
            <div class="order-summary">
                <h3 class="order-summary-title">
                    <span class="material-icons text-orange-600 mr-2 align-middle">shopping_cart</span>
                    Resumen del Pedido
                </h3>
                
                <div id="order-items">
                    <div class="no-products-selected" id="no-products">
                        <span class="material-icons text-gray-400 text-4xl mb-2">shopping_cart</span>
                        <p>No has seleccionado productos</p>
                    </div>
                </div>
                
                <div class="order-summary-total" id="order-total" style="display: none;">
                    <span class="order-summary-total-label">Total:</span>
                    <span class="order-summary-total-amount" id="total-amount">$0</span>
                </div>
                
                <!-- Informaci√≥n de entrega -->
                <div class="mt-4 pt-4 border-t border-orange-300" id="delivery-info" style="display: none;">
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Subtotal:</span>
                            <span id="subtotal-amount">$0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Env√≠o:</span>
                            <span id="shipping-amount">Gratis</span>
                        </div>
                        <div class="flex justify-between font-semibold text-orange-600">
                            <span>Total Final:</span>
                            <span id="final-amount">$0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Informaci√≥n importante -->
                <div class="mt-4 pt-4 border-t border-orange-300">
                    <div class="text-xs text-gray-600 space-y-1">
                        <p><strong>Pedido m√≠nimo:</strong> ${{ settings.minimum_order_amount|floatformat:0|intcomma|default:"20,000" }}</p>
                        <p><strong>Env√≠o gratis desde:</strong> ${{ settings.free_delivery_threshold|floatformat:0|intcomma|default:"50,000" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Inputs hidden para los productos seleccionados -->
    <div id="hidden-inputs"></div>
</form>

<!-- MODAL DE PRODUCTOS -->
<div class="modal-overlay" id="products-modal">
    <div class="modal-content">
        <!-- Header -->
        <div class="modal-header">
            <div>
                <h2 class="modal-title">üõí Nuestros Productos</h2>
                <p class="modal-subtitle">{{ products.count }} productos disponibles</p>
            </div>
            <button type="button" id="close-modal" class="modal-close-btn">
                <span class="material-icons">close</span>
            </button>
        </div>
        
        <!-- Body -->
        <div class="modal-body">
            <!-- Buscador -->
            <div class="search-container">
                <span class="material-icons search-icon">search</span>
                <input type="text" 
                       id="product-search" 
                       class="search-input"
                       placeholder="Buscar productos...">
            </div>
            
            <!-- Filtros de categor√≠a -->
            <div class="category-filters-modal">
                <a href="#" class="category-filter-modal active" data-category="">Todos</a>
                {% for category in categories %}
                    <a href="#" class="category-filter-modal" data-category="{{ category.slug }}">{{ category.name }}</a>
                {% endfor %}
            </div>
            
            <!-- Grid de productos -->
            <div class="products-grid-modal" id="products-grid-modal">
                {% for product in products %}
                    <div class="product-modal-card" 
                         data-product-id="{{ product.id }}"
                         data-category="{{ product.category.slug }}"
                         data-name="{{ product.name|lower }}"
                         onclick="window.handleProductClick && window.handleProductClick({{ product.id }})"
                         oncontextmenu="window.viewProductDetails && window.viewProductDetails({{ product.id }}); return false;"
                         ontouchstart="window.handleTouchStart && window.handleTouchStart({{ product.id }})"
                         ontouchend="window.handleTouchEnd && window.handleTouchEnd({{ product.id }})">
                        
                        <!-- Imagen del producto -->
                        <div class="product-modal-image">
                            {% if product.image %}
                                <div class="image-skeleton-modal" id="skeleton-{{ product.id }}">
                                    <div class="skeleton-shimmer"></div>
                                </div>
                                <img src="{{ product.image.url }}" 
                                     alt="{{ product.name }}"
                                     loading="lazy"
                                     onload="window.imageLoaded && window.imageLoaded({{ product.id }}, '{{ product.image.url|escapejs }}')"
                                     onerror="window.imageError && window.imageError({{ product.id }}, '{{ product.image.url|escapejs }}')"
                                     style="display: none;"
                                     id="img-{{ product.id }}"
                                     data-src="{{ product.image.url }}">
                            {% else %}
                                <div class="no-image-placeholder">
                                    <span class="material-icons text-gray-400 text-2xl">bakery_dining</span>
                                    <span class="text-xs text-gray-500 mt-1">Sin imagen</span>
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Informaci√≥n del producto -->
                        <div class="product-modal-info">
                            <!-- Nombre y peso en la misma l√≠nea -->
                            <div class="product-name-weight">
                                <h4>{{ product.name }}</h4>
                                {% if product.weight %}
                                    <div class="product-modal-weight">{{ product.weight }}g</div>
                                {% endif %}
                            </div>
                            
                            <!-- Precio abajo -->
                            <div class="product-modal-price">${{ product.price|floatformat:0|intcomma }}</div>
                        </div>

                        
                        <!-- Badge de seleccionado -->
                        <div class="selected-badge" id="badge-{{ product.id }}" style="display: none;">
                            <span class="material-icons">check</span>
                        </div>
                        
                        <!-- Estados de interacci√≥n -->
                        <div class="product-states">
                            <div class="state-normal" id="state-normal-{{ product.id }}">
                                <span class="material-icons">add_circle</span>
                                <span>Agregar</span>
                            </div>
                            <div class="state-selected" id="state-selected-{{ product.id }}" style="display: none;">
                                <span class="material-icons">check_circle</span>
                                <span>Agregado</span>
                            </div>
                        </div>
                        
                        <!-- Bot√≥n de detalles para m√≥vil -->
                        <button class="mobile-details-btn lg:hidden" 
                                onclick="event.stopPropagation(); window.viewProductDetails && window.viewProductDetails({{ product.id }})">
                            <span class="material-icons">info</span>
                        </button>
                    </div>
                {% empty %}
                    <div class="empty-products-message">
                        <span class="material-icons text-gray-400 text-4xl mb-2">inventory_2</span>
                        <p class="text-gray-600">No hay productos disponibles</p>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Footer -->
        <div class="modal-footer">
            <div class="modal-footer-info">
                <div class="mb-2">
                    <span id="selected-items-count">0</span> productos agregados
                </div>
                
                <!-- Caja informativa en el footer -->
                <div class="footer-info-box">
                    <div class="flex items-center gap-2">
                        <span class="material-icons text-blue-600">bookmark</span>
                        <div class="flex-1">
                            <span class="font-semibold text-blue-900">Detalles:</span>
                            <div class="text-xs text-blue-800">
                                <span class="responsive-text-mobile">Mant√©n presionado un producto para ver sus detalles</span>
                                <span class="responsive-text-desktop">Click derecho en un producto para ver sus detalles</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer-actions">
                <button type="button" id="clear-selection" class="btn-clear-selection">Limpiar todo</button>
                <button type="button" id="apply-selection" class="btn-apply-selection">Aplicar Selecci√≥n</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block step_js %}
<script>
console.log('üöÄ Step 2 JavaScript iniciando...');

// DATOS B√ÅSICOS
const products = {
{% for product in products %}
    "{{ product.id }}": {
        "name": "{{ product.name|escapejs }}",
        "price": {{ product.price|default:0|floatformat:0 }},
        "category": "{{ product.category.name|escapejs }}",
        "imageUrl": "{% if product.image %}{{ product.image.url|escapejs }}{% endif %}"
    }{% if not forloop.last %},{% endif %}
{% endfor %}
};

const settings = {
    "minimumOrder": {{ settings.minimum_order_amount|default:20000|floatformat:0 }},
    "freeDeliveryThreshold": {{ settings.free_delivery_threshold|default:50000|floatformat:0 }}
};

let selectedProducts = new Set();
let touchTimers = new Map();

console.log('üìä Datos cargados:');
console.log('- Productos:', Object.keys(products).length);
console.log('- Productos con imagen:', Object.values(products).filter(p => p.imageUrl).length);

// FUNCIONES PARA MANEJO DE IM√ÅGENES CON LOGS DETALLADOS
window.imageLoaded = function(productId, imageUrl) {
    console.log(`‚úÖ [IMG-LOAD] Producto ${productId}:`);
    console.log(`   üì∑ URL: ${imageUrl}`);
    console.log(`   ‚è±Ô∏è Tiempo: ${Date.now()}`);
    
    const skeleton = document.getElementById(`skeleton-${productId}`);
    const img = document.getElementById(`img-${productId}`);
    
    if (skeleton) {
        skeleton.style.display = 'none';
        console.log(`   üé≠ Skeleton ocultado para producto ${productId}`);
    } else {
        console.warn(`   ‚ö†Ô∏è No se encontr√≥ skeleton para producto ${productId}`);
    }
    
    if (img) {
        img.style.display = 'block';
        img.style.opacity = '1';
        console.log(`   üñºÔ∏è Imagen mostrada para producto ${productId}`);
    } else {
        console.warn(`   ‚ö†Ô∏è No se encontr√≥ elemento img para producto ${productId}`);
    }
};

window.imageError = function(productId, imageUrl) {
    console.error(`‚ùå [IMG-ERROR] Producto ${productId}:`);
    console.error(`   üì∑ URL fallida: ${imageUrl}`);
    console.error(`   ‚è±Ô∏è Tiempo: ${Date.now()}`);
    
    const skeleton = document.getElementById(`skeleton-${productId}`);
    const imgContainer = skeleton?.parentElement;
    
    if (skeleton) {
        skeleton.style.display = 'none';
        console.log(`   üé≠ Skeleton ocultado tras error para producto ${productId}`);
    }
    
    if (imgContainer) {
        imgContainer.innerHTML = `
            <div class="no-image-placeholder">
                <span class="material-icons text-red-400 text-2xl">broken_image</span>
                <span class="text-xs text-red-500 mt-1">Error al cargar</span>
            </div>
        `;
        console.log(`   üîÑ Placeholder de error insertado para producto ${productId}`);
    } else {
        console.warn(`   ‚ö†Ô∏è No se encontr√≥ contenedor de imagen para producto ${productId}`);
    }
};

// FUNCIONES DEL MODAL
window.openModal = function() {
    console.log('üìÇ Abriendo modal...');
    const modal = document.getElementById('products-modal');
    if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        console.log('‚úÖ Modal abierto');
        
        const pendingImages = document.querySelectorAll('.image-skeleton-modal:not([style*="display: none"])');
        console.log(`üîÑ Im√°genes pendientes de cargar: ${pendingImages.length}`);
        
        pendingImages.forEach((skeleton, index) => {
            const productId = skeleton.id.replace('skeleton-', '');
            const img = document.getElementById(`img-${productId}`);
            const imageUrl = img?.getAttribute('data-src') || img?.src;
            console.log(`   ${index + 1}. Producto ${productId} - URL: ${imageUrl}`);
        });
    }
};

window.closeModal = function() {
    console.log('üîí Cerrando modal...');
    const modal = document.getElementById('products-modal');
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
        console.log('‚úÖ Modal cerrado');
    }
};

window.viewProductDetails = function(productId) {
    console.log('üîç Ver detalles del producto:', productId);
    const detailUrl = `/products/${productId}/`;
    window.open(detailUrl, '_blank');
};

window.handleTouchStart = function(productId) {
    console.log('üëÜ Touch start:', productId);
    
    const timer = setTimeout(() => {
        console.log('‚è∞ Long press detectado:', productId);
        window.viewProductDetails(productId);
        if (navigator.vibrate) {
            navigator.vibrate(50);
        }
    }, 500);
    
    touchTimers.set(productId, timer);
};

window.handleTouchEnd = function(productId) {
    console.log('üëÜ Touch end:', productId);
    
    const timer = touchTimers.get(productId);
    if (timer) {
        clearTimeout(timer);
        touchTimers.delete(productId);
    }
};

window.handleProductClick = function(productId) {
    console.log('üñ±Ô∏è Product click:', productId);
    
    const timer = touchTimers.get(productId);
    if (timer) {
        clearTimeout(timer);
        touchTimers.delete(productId);
    }
    
    window.toggleProductSelection(productId);
};

window.toggleProductSelection = function(productId) {
    console.log('üîÑ Toggle selecci√≥n producto:', productId);
    const card = document.querySelector(`[data-product-id="${productId}"]`);
    const badge = document.getElementById(`badge-${productId}`);
    const stateNormal = document.getElementById(`state-normal-${productId}`);
    const stateSelected = document.getElementById(`state-selected-${productId}`);
    
    if (selectedProducts.has(productId)) {
        selectedProducts.delete(productId);
        card?.classList.remove('selected');
        if (badge) badge.style.display = 'none';
        if (stateNormal) stateNormal.style.display = 'flex';
        if (stateSelected) stateSelected.style.display = 'none';
        console.log('‚ùå Producto removido:', productId);
    } else {
        selectedProducts.add(productId);
        card?.classList.add('selected');
        if (badge) badge.style.display = 'flex';
        if (stateNormal) stateNormal.style.display = 'none';
        if (stateSelected) stateSelected.style.display = 'flex';
        console.log('‚úÖ Producto agregado:', productId);
    }
    
    window.updateSelectedCount();
};

window.updateSelectedCount = function() {
    const count = selectedProducts.size;
    const element = document.getElementById('selected-items-count');
    if (element) {
        element.textContent = count;
    }
    console.log('üìä Total productos seleccionados:', count);
};

window.clearSelection = function() {
    console.log('üßπ Limpiando selecci√≥n...');
    selectedProducts.clear();
    
    document.querySelectorAll('.product-modal-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    document.querySelectorAll('.selected-badge').forEach(badge => {
        badge.style.display = 'none';
    });
    
    document.querySelectorAll('.state-normal').forEach(state => {
        state.style.display = 'flex';
    });
    document.querySelectorAll('.state-selected').forEach(state => {
        state.style.display = 'none';
    });
    
    window.updateSelectedCount();
    console.log('‚úÖ Selecci√≥n limpiada');
};

window.applySelection = function() {
    console.log('‚úÖ Aplicando selecci√≥n...');
    console.log('Productos seleccionados:', Array.from(selectedProducts));
    
    if (selectedProducts.size === 0) {
        alert('Debes seleccionar al menos un producto');
        return;
    }
    
    window.updateMainProductsSection();
    window.closeModal();
    
    console.log('‚úÖ Selecci√≥n aplicada');
};

window.updateMainProductsSection = function() {
    const container = document.querySelector('.empty-products-container');
    const count = selectedProducts.size;
    
    console.log('üîÑ Actualizando secci√≥n principal. Productos:', count);
    
    if (container && count > 0) {
        container.innerHTML = `
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center w-20 h-20 md:w-24 md:h-24 bg-green-100 rounded-full mb-4 md:mb-6">
                    <span class="material-icons text-green-600 text-3xl md:text-4xl">check_circle</span>
                </div>
                <h3 class="text-base md:text-lg font-medium text-gray-900 mb-2">${count} producto${count > 1 ? 's' : ''} agregado${count > 1 ? 's' : ''}</h3>
                <p class="text-sm md:text-base text-gray-500 mb-4 md:mb-6">Ahora puedes ajustar las cantidades de cada producto</p>
                <button type="button" 
                        class="btn-modify-products"
                        onclick="window.openModal();">
                    <span class="material-icons mr-2">edit</span>
                    Modificar Selecci√≥n
                </button>
            </div>
        `;
        
        window.showSelectedProductsWithQuantity();
        console.log('‚úÖ Secci√≥n principal actualizada');
    }
};

window.showSelectedProductsWithQuantity = function() {
    console.log('üìù TODO: Implementar vista de productos con cantidades');
};

// FILTROS DE CATEGOR√çA
window.setupCategoryFilters = function() {
    console.log('üè∑Ô∏è Configurando filtros de categor√≠a...');
    
    const filterButtons = document.querySelectorAll('.category-filter-modal');
    const productCards = document.querySelectorAll('.product-modal-card');
    
    console.log(`üìä Filtros encontrados: ${filterButtons.length}`);
    console.log(`üì¶ Cards de productos: ${productCards.length}`);
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const selectedCategory = this.getAttribute('data-category');
            console.log(`üîÑ Filtro seleccionado: "${selectedCategory || 'Todos'}"`);
            
            // Actualizar estado activo de los botones
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Filtrar productos
            let visibleCount = 0;
            productCards.forEach(card => {
                const cardCategory = card.getAttribute('data-category');
                const shouldShow = !selectedCategory || cardCategory === selectedCategory;
                
                if (shouldShow) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            console.log(`üëÅÔ∏è Productos visibles: ${visibleCount}/${productCards.length}`);
            
            // Mostrar mensaje si no hay productos
            window.updateEmptyState(visibleCount === 0);
        });
    });
    
    console.log('‚úÖ Filtros de categor√≠a configurados');
};

window.updateEmptyState = function(isEmpty) {
    const grid = document.getElementById('products-grid-modal');
    let emptyMessage = document.getElementById('empty-filter-message');
    
    if (isEmpty) {
        if (!emptyMessage) {
            emptyMessage = document.createElement('div');
            emptyMessage.id = 'empty-filter-message';
            emptyMessage.className = 'empty-products-message';
            emptyMessage.innerHTML = `
                <span class="material-icons text-gray-400 text-4xl mb-2">filter_list_off</span>
                <p class="text-gray-600">No hay productos en esta categor√≠a</p>
            `;
            grid.appendChild(emptyMessage);
        }
        emptyMessage.style.display = 'flex';
    } else {
        if (emptyMessage) {
            emptyMessage.style.display = 'none';
        }
    }
};

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Configurando event listeners...');
    
    const allImages = document.querySelectorAll('img[id^="img-"]');
    console.log(`üñºÔ∏è Total de im√°genes en el DOM: ${allImages.length}`);
    
    allImages.forEach((img, index) => {
        const productId = img.id.replace('img-', '');
        const imageUrl = img.src || img.getAttribute('data-src');
        console.log(`   ${index + 1}. Producto ${productId} - URL: ${imageUrl} - Estado: ${img.complete ? 'Cargada' : 'Pendiente'}`);
        
        if (img.complete && img.naturalHeight !== 0) {
            window.imageLoaded(productId, imageUrl);
        }
    });
    
    const addBtn = document.getElementById('add-products-btn');
    if (addBtn) {
        addBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.openModal();
        });
        console.log('‚úÖ Bot√≥n principal configurado');
    }
    
    const closeBtn = document.getElementById('close-modal');
    const applyBtn = document.getElementById('apply-selection');
    const clearBtn = document.getElementById('clear-selection');
    
    if (closeBtn) closeBtn.addEventListener('click', window.closeModal);
    if (applyBtn) applyBtn.addEventListener('click', window.applySelection);
    if (clearBtn) clearBtn.addEventListener('click', window.clearSelection);
    
    // Configurar filtros de categor√≠a
    window.setupCategoryFilters();
    
    console.log('üéØ Inicializaci√≥n completa');
});

console.log('üìù Script cargado completamente');
</script>
{% endblock %}